<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Healthy Browsing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fafafa;
      margin: 40px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 20px;
    }
    .chart-container {
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 10px;
    }
    .chart-container svg {
      width: 100%;
      height: 400px;
    }
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
    }
    .legend {
      font-size: 12px;
    }
    select {
      font-size: 14px;
      padding: 6px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Healthy Browsing</h1>
  <p>Your browser history can tell stories about your mental health, from an increase in overall usage, frequency of certain sites, and keywords presented on the site. Explore the visuals below about your internet history.</p>
  <div class="grid-container">
    <div class="chart-container">
      <svg id="barChart" width="600" height="400"></svg>
    </div>
    <div class="chart-container">
      <h3>Donut Chart</h3>
      <p>Filter Donut Chart by Day of Week:</p>
      <select id="dayDropdown"></select>
      <svg id="donutChart" width="600" height="400"></svg>
    </div>
    <div class="chart-container">
      <svg id="chart2" width="600" height="400"></svg>
    </div>
    <div class="chart-container">
      <p style="text-align:center; padding-top: 180px; color: #aaa;">Add another chart or summary here.</p>
    </div>
  </div>

  <div class="tooltip" style="opacity: 0;"></div>

  <script>
    const tooltip = d3.select(".tooltip");

    // Bar Chart
    d3.csv("chart1.csv", d3.autoType).then(function(data) {
      const validData = data.filter(d => d.domain && d.domain !== "");
      const domainCounts = d3.rollup(validData, v => v.length, d => d.domain);
      const processedData = Array.from(domainCounts, ([domain, count]) => ({ domain, count }))
        .sort((a, b) => d3.descending(a.count, b.count))
        .slice(0, 10);

      const svg = d3.select("#barChart"),
            margin = {top: 40, right: 20, bottom: 60, left: 180},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;

      const chart = svg.append("g")
                       .attr("transform", `translate(${margin.left},${margin.top})`);

      const y = d3.scaleBand()
                  .domain(processedData.map(d => d.domain))
                  .range([0, height])
                  .padding(0.15);

      const x = d3.scaleLinear()
                  .domain([0, d3.max(processedData, d => d.count)])
                  .range([0, width]);

      chart.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x));
      chart.append("g").call(d3.axisLeft(y));

      svg.append("text")
         .attr("x", +svg.attr("width") / 2)
         .attr("y", 25)
         .attr("text-anchor", "middle")
         .attr("font-size", "18px")
         .attr("fill", "#333")
         .text("Top 10 Most Visited Domains");

      chart.selectAll("rect")
           .data(processedData)
           .enter()
           .append("rect")
           .attr("y", d => y(d.domain))
           .attr("x", 0)
           .attr("height", y.bandwidth())
           .attr("width", 0)
           .attr("fill", "#69b3a2")
           .transition()
           .duration(1000)
           .attr("width", d => x(d.count))
           .on("mouseover", function(event, d) {
              tooltip.transition().duration(200).style("opacity", 1);
              tooltip.html(`<strong>${d.domain}</strong><br>${d.count} visits`)
                     .style("left", (event.pageX + 10) + "px")
                     .style("top", (event.pageY - 28) + "px");
              d3.select(this).attr("fill", "#4c837a");
           })
           .on("mouseout", function() {
              tooltip.transition().duration(300).style("opacity", 0);
              d3.select(this).attr("fill", "#69b3a2");
           });
    });

    // Donut Chart
    d3.csv("FinalAggregatedDataset.csv", d3.autoType).then(function(data) {
      const allDays = Array.from(new Set(data.map(d => d["Day of Week"]))).sort();
      const dropdown = d3.select("#dayDropdown");
      
      svg.append("text")
         .attr("x", +svg.attr("width") / 2)
         .attr("y", 25)
         .attr("text-anchor", "middle")
         .attr("font-size", "18px")
         .attr("fill", "#333")
         .text("Internet traffic by keywords ");
      
      dropdown.selectAll("option")
              .data(allDays)
              .enter()
              .append("option")
              .text(d => d)
              .attr("value", d => d);

      drawDonut(data, allDays[0]);

      dropdown.on("change", function() {
        const selectedDay = d3.select(this).property("value");
        drawDonut(data, selectedDay);
      });

      function drawDonut(data, dayFilter) {
        const svg = d3.select("#donutChart");
        svg.selectAll("*").remove();

        const filtered = data.filter(d => d["Day of Week"] === dayFilter);
        const grouped = d3.rollup(filtered, v => v.length, d => d["Hour (bins)"]);
        const donutData = Array.from(grouped, ([label, value]) => ({ label, value }));

        const width = +svg.attr("width"),
              height = +svg.attr("height"),
              radius = Math.min(width, height) / 2 - 50;

        const chart = svg.append("g")
                         .attr("transform", `translate(${width / 2}, ${height / 2 - 50})`);

        const color = d3.scaleOrdinal()
                        .domain(donutData.map(d => d.label))
                        .range(d3.schemeTableau10);

        const pie = d3.pie().value(d => d.value).sort(null);
        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);

        chart.selectAll("path")
             .data(pie(donutData))
             .enter()
             .append("path")
             .attr("fill", d => color(d.data.label))
             .attr("d", arc)
             .on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`<strong>${d.data.label}</strong><br>${d.data.value} visits`)
                       .style("left", (event.pageX + 10) + "px")
                       .style("top", (event.pageY - 28) + "px");
             })
             .on("mouseout", function() {
                tooltip.transition().duration(300).style("opacity", 0);
             });
      }
    });

    // Line Chart
               // set the dimensions and margins of the graph
            var margin = {top: 10, right: 30, bottom: 30, left: 60},
                width = 460 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;
            
            // append the svg object to the body of the page
            var svg = d3.select("#chart2")
              .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");
            
            //Read the data
            d3.csv("chart2.csv",
            
              // When reading the csv, I must format variables:
              function(d){
                return { date : d3.timeParse("%Y-%m-%d")(d.date), value : d.value }
              },
            
              // Now I can use this dataset:
              function(data) {
            
                // Add X axis --> it is a date format
                var x = d3.scaleTime()
                  .domain(d3.extent(data, function(d) { return d.date; }))
                  .range([ 0, width ]);
                svg.append("g")
                  .attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(x));
            
                // Max value observed:
                const max = d3.max(data, function(d) { return +d.value; })
            
                // Add Y axis
                var y = d3.scaleLinear()
                  .domain([0, max])
                  .range([ height, 0 ]);
                svg.append("g")
                  .call(d3.axisLeft(y));
            
                // Set the gradient
                svg.append("linearGradient")
                  .attr("id", "line-gradient")
                  .attr("gradientUnits", "userSpaceOnUse")
                  .attr("x1", 0)
                  .attr("y1", y(0))
                  .attr("x2", 0)
                  .attr("y2", y(max))
                  .selectAll("stop")
                    .data([
                      {offset: "0%", color: "blue"},
                      {offset: "100%", color: "red"}
                    ])
                  .enter().append("stop")
                    .attr("offset", function(d) { return d.offset; })
                    .attr("stop-color", function(d) { return d.color; });
            
                // Add the line
                svg.append("path")
                  .datum(data)
                  .attr("fill", "none")
                  .attr("stroke", "url(#line-gradient)" )
                  .attr("stroke-width", 2)
                  .attr("d", d3.line()
                    .x(function(d) { return x(d.date) })
                    .y(function(d) { return y(d.value) })
                    )

})
    });
  </script>
</body>
</html>
